#!/bin/bash

##############################################################################
# jailcreate.sh configuration file
##############################################################################
# NOTE: This file is automatically generated by puppet
# Changes to this file will be overwritten periodically by puppet!
##############################################################################

# This is a simple script to automatize creation of sftp-jailed users
export PATH=$PATH:/usr/local/jailkit/sbin:/usr/local/jailkit/sbin
echo -n "Jail name: "
read jail
echo -n "User name: "
read user
JAILROOT="<%= jailroot %>"
ROOT="$JAILROOT/jail_$jail"

echo -n "Comments (ex: Ticket number): "
read comm

# Conf file for jailkit, different for each jail
CONF="etc/jailkit/jk_lsh.ini"

# Script begin
if [ ! -d $ROOT ] ; then 
mkdir $ROOT
jk_init -v $ROOT sftp scp
jk_init -v $ROOT jk_lsh
mkdir $ROOT/home
fi 

useradd -m $user -c "$comm" -d $ROOT/home/$user
passwd $user

# Copy the necessary files to the jail and assign the user to the jail
jk_jailuser -m -j $ROOT $user

# Necessary lines to complete the assignation
echo "[$user]" >> $ROOT/$CONF
echo "paths = /usr/bin, /usr/lib/" >>$ROOT/$CONF
echo "executables = /usr/bin/scp, /usr/libexec/openssh/sftp-server" >>$ROOT/$CONF

echo "Jail created for $user :)"
exit 0
